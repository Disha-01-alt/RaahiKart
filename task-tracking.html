<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tracking - RaahiKart</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>.progress-step{display:flex;align-items:flex-start;margin-bottom:1.5rem;position:relative;opacity:.5;transition:opacity .3s ease}.progress-step.completed,.progress-step.active{opacity:1}.progress-step:not(:last-child)::after{content:'';position:absolute;left:20px;top:50px;width:2px;height:100%;background:#e9ecef}.progress-step.completed::after{background:#28a745}.step-icon{width:40px;height:40px;border-radius:50%;background:#e9ecef;display:flex;align-items:center;justify-content:center;margin-right:1rem;font-size:1.2rem;flex-shrink:0}.progress-step.completed .step-icon{background:#28a745;color:#fff}.progress-step.active .step-icon{background:#f46a1a;color:#fff}</style>
</head>
<body>
    <header>
        <nav class="container">
            <a href="index.html" class="logo">üöö RaahiKart</a>
            <ul class="nav-links"><li><a href="profile.html">My Profile</a></li><li><a href="index.html" onclick="logout()">Logout</a></li></ul>
        </nav>
    </header>
    <main class="dashboard">
        <div class="container">
            <div class="dashboard-header"><h1>üìç Live Task Tracking</h1></div>
            
            <div class="card"><div class="card-header"><h3>Task #<span id="taskId">...</span></h3><span id="taskStatusBadge" class="status-badge">...</span></div></div>
            <div class="card"><h3 id="otherPartyTitle" class="card-title">Contact Details</h3><div id="otherPartyDetails"><p>Loading...</p></div></div>
            <div class="card"><h3 class="card-title">üó∫Ô∏è Live Map</h3><div id="trackingMap" style="height: 400px;"></div></div>

            <!-- RIDER'S VIEW: PIN Inputs -->
            <div id="riderActionPanel" class="card" style="display: none;">
                <h3 class="card-title">Manage Delivery</h3>
                <div id="pickupSection" style="display:none;"><h4>Step 1: Confirm Pickup</h4><p>Enter the 4-digit Pickup PIN from the sender.</p><div class="form-group"><input type="text" id="pickupPinInput" class="form-control" placeholder="4-Digit PIN" maxlength="4"></div><button class="btn btn-primary" style="width:100%;" onclick="updateStatus('in_transit', event)">Confirm Pickup</button></div>
                <div id="deliverySection" style="display:none;"><h4>Step 2: Confirm Delivery</h4><p>Enter the 4-digit Delivery PIN from the recipient.</p><div class="form-group"><input type="text" id="deliveryPinInput" class="form-control" placeholder="4-Digit PIN" maxlength="4"></div><button class="btn btn-success" style="width:100%;" onclick="updateStatus('delivered', event)">Confirm Delivery & Finish Task</button></div>
            </div>

            <!-- SENDER'S VIEW: PIN Display -->
            <div id="senderInfoPanel" class="card" style="display: none;">
                <h3 class="card-title">üîê Verification PINs</h3>
                <div class="dashboard-grid">
                    <div><h4>Pickup PIN</h4><p>Give this code to the rider when they pick up the item.</p><strong style="font-size: 1.5rem; color: #f46a1a;" id="pickupPinDisplay">----</strong></div>
                    <div><h4>Delivery PIN</h4><p>Share this with the recipient to give to the rider upon delivery.</p><strong style="font-size: 1.5rem; color: #28a745;" id="deliveryPinDisplay">----</strong></div>
                </div>
            </div>

            <div class="card"><h3 class="card-title">üìã Delivery Progress</h3><div id="progressSteps"><!-- ... progress steps HTML ... --></div></div>
        </div>
    </main>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/scripts.js"></script>
    <script>
        let currentUser, currentTaskId, unsubscribe, map, riderMarker, directionsRenderer, locationUpdateInterval;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                currentTaskId = urlParams.get('taskId');
                if (currentTaskId) {
                    document.getElementById('taskId').textContent = currentTaskId;
                    loadGoogleMapsScript();
                }
            } else { window.location.href = 'signin.html'; }
        });

        function initMap() {
            map = new google.maps.Map(document.getElementById('trackingMap'), { center: { lat: 22.9734, lng: 78.6569 }, zoom: 5 });
            directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
            directionsRenderer.setMap(map);
            startRealtimeTracking(currentTaskId);
        }

        function startRealtimeTracking(taskId) {
            const taskRef = db.collection('p2p_tasks').doc(taskId);
            unsubscribe = taskRef.onSnapshot(doc => {
                if (doc.exists) {
                    updateUI(doc.data());
                } else {
                    if (unsubscribe) unsubscribe();
                    showNotification("This task is no longer active.", "info");
                }
            });
        }
        
        function updateUI(taskData) {
            // --- START: CRITICAL FIX FOR POST-DELIVERY FLOW ---
            // If the status is 'delivered', stop everything and redirect to feedback.
            if (taskData.status === 'delivered') {
                if (locationUpdateInterval) stopSendingLocationUpdates();
                if (unsubscribe) unsubscribe();
                
                showNotification('Delivery Completed! Please provide your feedback.', 'success');
                setTimeout(() => {
                    window.location.href = `feedback.html?taskId=${currentTaskId}`;
                }, 2000); // 2-second delay to let the user read the message
                return; // Stop further UI updates on this page
            }
            // --- END: CRITICAL FIX FOR POST-DELIVERY FLOW ---

            const isSender = currentUser.uid === taskData.senderId;
            const isRider = currentUser.uid === taskData.riderId;
            
            document.getElementById('taskStatusBadge').textContent = taskData.status.replace('_', ' ').toUpperCase();
            
            const otherPartyId = isSender ? taskData.riderId : taskData.senderId;
            document.getElementById('otherPartyTitle').textContent = isSender ? "Your Rider's Details" : "Sender & Recipient Details";
            if (otherPartyId) { fetchOtherPartyDetails(otherPartyId, taskData, isRider); }
            
            document.getElementById('riderActionPanel').style.display = isRider ? 'block' : 'none';
            document.getElementById('senderInfoPanel').style.display = isSender ? 'block' : 'none';
            if (isRider) {
                document.getElementById('pickupSection').style.display = taskData.status === 'accepted' ? 'block' : 'none';
                document.getElementById('deliverySection').style.display = taskData.status === 'in_transit' ? 'block' : 'none';
            }
            if (isSender) {
                document.getElementById('pickupPinDisplay').textContent = taskData.pickupPIN || '----';
                document.getElementById('deliveryPinDisplay').textContent = taskData.deliveryPIN || '----';
            }
            if (isRider && (taskData.status === 'accepted' || taskData.status === 'in_transit')) {
                if (!locationUpdateInterval) startSendingLocationUpdates(currentTaskId);
            } else {
                if (locationUpdateInterval) stopSendingLocationUpdates();
            }
            updateMap(taskData);
            updateProgressSteps(taskData.status);
        }

        async function updateStatus(newStatus, event) {
            const idToken = localStorage.getItem('raahikartIdToken');
            const pinInput = (newStatus === 'in_transit') ? document.getElementById('pickupPinInput') : document.getElementById('deliveryPinInput');
            const pin = pinInput.value;
            if (!pin || pin.length !== 4) return showNotification('Please enter the 4-digit PIN.', 'error');
            
            const submitBtn = event.target;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Verifying...';

            try {
                showNotification("Getting your location for verification...", 'info');
                const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, {enableHighAccuracy: true}));
                const location = { lat: position.coords.latitude, lng: position.coords.longitude };
                const response = await fetch(`${API_BASE_URL}/tasks/update-status`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` }, 
                    body: JSON.stringify({ taskId: currentTaskId, status: newStatus, pin: pin, location: location }) 
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                // No success message here, because the updateUI function will handle the redirect
            } catch (error) {
                showNotification(`Update failed: ${error.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = newStatus === 'in_transit' ? 'Confirm Pickup' : 'Confirm Delivery';
            }
        }
        
        // All other helper functions (fetchOtherPartyDetails, updateMap, updateProgressSteps,
        // startSendingLocationUpdates, stopSendingLocationUpdates) are correct and remain the same.

        window.onbeforeunload = () => {
            if (unsubscribe) unsubscribe();
            stopSendingLocationUpdates();
        };
    </script>
</body>
</html>
